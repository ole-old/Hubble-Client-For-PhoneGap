/*! backbone-pouch - v1.0.0 - 2013-05-02
* http://jo.github.io/backbone-pouch/
* Copyright (c) 2013 Johannes J. Schmidt; Licensed MIT */
(function(e){"use strict";function t(e,t){e.options=e.options||{},t.options=t.options||{},typeof e.fetch=="undefined"&&(e.fetch=t.fetch),typeof e.listen=="undefined"&&(e.listen=t.listen),typeof e.db=="undefined"&&(e.db=t.db),n.each(t.options,function(t,o){e.options[o]=e.options[o]||{},n.extend(e.options[o],t)})}var o;o="object"==typeof exports?exports:e.BackbonePouch={};var n=e._;n||"function"!=typeof require||(n=require("underscore"));var i={create:"post",update:"put",patch:"put","delete":"remove"};o.defaults={fetch:"allDocs",listen:!0,options:{post:{},put:{},get:{},remove:{},allDocs:{include_docs:!0},query:{include_docs:!0},spatial:{include_docs:!0},changes:{continuous:!0,include_docs:!0}}},o.sync=function(e){e=e||{},t(e,o.defaults);var s=function(o,s,c){function r(e,t){return e?c.error&&c.error(e):(("create"===o||"update"===o||"patch"===o)&&(t={_id:t.id,_rev:t.rev}),"delete"===o&&(t={}),"read"===o&&(t.rows&&(t=n.map(t.rows,function(e){return e.doc||n.extend({_id:e.id},e.value)})),c.listen&&c.db.info(function(e,t){c.db.changes(n.extend({},c.options.changes,{since:t.update_seq,onChange:function(e){var t=s.get(e.id);e.deleted?t&&t.destroy():t?t.set(e.doc):s.add(e.doc),typeof c.options.changes.onChange=="function"&&c.options.changes.onChange(e)}}))})),c.success&&c.success(t))}if(c=c||{},t(c,s.pouch||{}),t(c,e),!c.db)throw Error('A "db" property must be specified');if(s.trigger("request",s,c.db,c),"read"===o){if(s.id)return c.db.get(s.id,c.options.get,r);if(c.fetch==="query"||c.fetch==="spatial"){if(!c.options[c.fetch].fun)throw Error('A "'+c.fetch+'.fun" object must be specified');return c.db[c.fetch](c.options[c.fetch].fun,c.options[c.fetch],r)}c.db[c.fetch](c.options[c.fetch],r)}else c.db[i[o]](s.toJSON(),c.options[i[o]],r);return c};return s.defaults=e,s}})(this);